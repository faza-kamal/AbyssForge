<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AbyssForge — Scan #{{ scan.id }}</title>
<style>
:root { --bg: #0f172a; --card: #1e293b; --border: #334155;
        --text: #e2e8f0; --muted: #94a3b8; --accent: #38bdf8; }
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; }
nav { background: #0c1929; border-bottom: 1px solid var(--border);
      padding: 14px 24px; display: flex; align-items: center; gap: 16px; }
nav a { color: var(--accent); text-decoration: none; font-size: 1.2rem; font-weight: 700; }
.container { max-width: 1100px; margin: 0 auto; padding: 28px 16px; }
h2 { font-size: 1.1rem; font-weight: 700; color: var(--accent);
     margin: 24px 0 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
             gap: 12px; background: var(--card); border-radius: 8px; padding: 16px; }
.info-item label { color: var(--muted); font-size: 11px; display: block; text-transform: uppercase; }
.info-item span { font-weight: 600; }
.stats-row { display: flex; gap: 12px; flex-wrap: wrap; margin: 16px 0; }
.stat-pill { padding: 8px 18px; border-radius: 8px; font-weight: 700; color: #fff; font-size: 14px; }
.finding-card { background: var(--card); border-radius: 8px; margin-bottom: 8px;
                border: 1px solid var(--border); }
.finding-header { padding: 12px 16px; cursor: pointer; display: flex;
                  align-items: center; gap: 10px; }
.finding-header:hover { background: #263548; }
.sev-pill { padding: 3px 10px; border-radius: 20px; font-size: 11px;
            font-weight: 700; color: #fff; white-space: nowrap; }
.finding-title { flex: 1; font-weight: 600; font-size: 14px; }
.cvss { background: #1e3a5f; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: var(--accent); }
.finding-body { display: none; padding: 16px; border-top: 1px solid var(--border); }
.finding-body.open { display: block; }
.detail-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
.detail-table th { width: 120px; text-align: left; color: var(--muted); padding: 5px 12px 5px 0; font-size: 12px; }
.detail-table td code { background: #0f172a; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
.section-label { font-size: 11px; font-weight: 700; color: var(--accent);
                 text-transform: uppercase; letter-spacing: 1px; margin: 10px 0 5px; }
pre.code-block { background: #0f172a; border: 1px solid var(--border); border-radius: 6px;
                 padding: 10px 12px; font-size: 12px; overflow-x: auto;
                 white-space: pre-wrap; word-break: break-all; color: #86efac; }
.remediation { background: #0c2e0c; border-left: 3px solid #22c55e;
               padding: 10px 14px; border-radius: 0 6px 6px 0; font-size: 13px; }
a { color: var(--accent); }
.actions { display: flex; gap: 10px; margin: 16px 0; }
.btn { padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600; }
.btn-primary { background: var(--accent); color: #0f172a; }
.btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
</style>
</head>
<body>
<nav>
  <a href="/">⚡ ABYSSFORGE</a>
  <span style="color:var(--muted)">&rsaquo; Scan #{{ scan.id }}</span>
</nav>
<div class="container">
  <h2>Informasi Scan</h2>
  <div class="info-grid">
    <div class="info-item"><label>Target</label><span>{{ scan.target }}</span></div>
    <div class="info-item"><label>Status</label><span>{{ scan.status }}</span></div>
    <div class="info-item"><label>Modul</label><span>{{ scan.modules }}</span></div>
    <div class="info-item"><label>Total Temuan</label><span>{{ scan.total_findings }}</span></div>
    <div class="info-item"><label>Mulai</label><span>{{ scan.created_at }}</span></div>
    <div class="info-item"><label>Selesai</label><span>{{ scan.finished_at or '-' }}</span></div>
  </div>

  <div class="actions">
    <a class="btn btn-primary" href="/report/{{ scan.id }}/html">↓ Download HTML</a>
    <a class="btn btn-secondary" href="/report/{{ scan.id }}/json">↓ Download JSON</a>
    <a class="btn btn-secondary" href="/">← Kembali</a>
  </div>

  <h2>Severity Summary</h2>
  <div class="stats-row">
    {% for sev, color in [('CRITICAL','#dc2626'),('HIGH','#ea580c'),('MEDIUM','#ca8a04'),('LOW','#2563eb'),('INFO','#6b7280')] %}
      {% if stats.get(sev, 0) %}
        <div class="stat-pill" style="background:{{ color }}">
          {{ sev }}: {{ stats.get(sev, 0) }}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <h2>Detail Temuan ({{ findings|length }})</h2>
  {% for f in findings %}
  {% set sev_colors = {'CRITICAL':'#dc2626','HIGH':'#ea580c','MEDIUM':'#ca8a04','LOW':'#2563eb','INFO':'#6b7280'} %}
  <div class="finding-card">
    <div class="finding-header" onclick="this.nextElementSibling.classList.toggle('open')">
      <span class="sev-pill" style="background:{{ sev_colors.get(f.severity,'#6b7280') }}">
        {{ f.severity }}
      </span>
      <span class="finding-title">{{ f.title }}</span>
      <span class="cvss">CVSS {{ '%.1f' % f.cvss_score }}</span>
    </div>
    <div class="finding-body {% if f.severity in ('CRITICAL','HIGH') %}open{% endif %}">
      <table class="detail-table">
        <tr><th>URL</th><td><code>{{ f.url }}</code></td></tr>
        {% if f.parameter %}<tr><th>Parameter</th><td><code>{{ f.parameter }}</code></td></tr>{% endif %}
        <tr><th>Method</th><td>{{ f.method }}</td></tr>
        <tr><th>Modul</th><td>{{ f.module }}</td></tr>
        <tr><th>Confidence</th><td>{{ f.confidence }}</td></tr>
      </table>
      <div class="section-label">Deskripsi</div>
      <p style="font-size:13px;margin-bottom:10px;">{{ f.description }}</p>
      {% if f.evidence %}
        <div class="section-label">Evidence</div>
        <pre class="code-block">{{ f.evidence[:600] }}</pre>
      {% endif %}
      {% if f.payload %}
        <div class="section-label">Payload</div>
        <pre class="code-block">{{ f.payload[:300] }}</pre>
      {% endif %}
      <div class="section-label">Remediasi</div>
      <div class="remediation">{{ f.remediation }}</div>
      {% if f.references %}
        <div class="section-label" style="margin-top:10px">Referensi</div>
        <a href="{{ f.references }}" target="_blank" style="font-size:12px">{{ f.references[:80] }}</a>
      {% endif %}
    </div>
  </div>
  {% else %}
  <p style="text-align:center;color:var(--muted);padding:40px;">✅ Tidak ada temuan.</p>
  {% endfor %}
</div>
</body>
</html>
